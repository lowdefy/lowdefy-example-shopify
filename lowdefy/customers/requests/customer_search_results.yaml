id: customer_search_results
type: MongoDBAggregation
connectionId: orders_mdb
properties:
  pipeline:
    - _if:
        test:
          _eq:
            - _state: search_input
            - null
        then:
          $match: {}
        else:
          $match:
            $text:
              $search:
                _state: search_input
    - $match:
        test: false
        financial_status: paid

    - $group:
        _id: $email
        first_name:
          $first: $customer.first_name
        last_name:
          $first: $customer.last_name
        total_orders:
          $sum: 1
        total_revenue:
          $sum:
            $toDouble: $subtotal_price
    - $sort:
        total_revenue: -1
    - $limit: 100
    - $addFields:
        name:
          $concat:
            - $first_name
            - ' '
            - $last_name
        total_revenue:
          $round:
            - $total_revenue
            - 2
        email: $_id