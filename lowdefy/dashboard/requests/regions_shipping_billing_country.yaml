id: regions_shipping_billing_country
type: MongoDBAggregation
connectionId: orders_mdb
properties:
  pipeline:
    - $match:
        test: false
        financial_status: paid
    - $addFields:
        start_date:
          _state: start_date
        end_date:
          $dateFromParts:
            year:
              $year:
                _state: end_date
            month:
              $month:
                _state: end_date
            day:
              $add:
                - $dayOfMonth:
                    _state: end_date
                - 1
    - $match:
        $expr:
          $and:
            - $gte:
              - $created_at_date
              - $start_date
            - $lt:
              - $created_at_date
              - $end_date      
    - $group:
        _id:
          bac: $billing_address.country
          sac: $shipping_address.country
          sap: $shipping_address.province
        total_orders:
          $sum: 1
        total_revenue:
          $sum:
            $toDouble: $subtotal_price
        total_customers:
          $addToSet: $email
    - $project:
        _id: 0
        billing_address_country: $_id.bac
        shipping_address_country: $_id.sac
        shipping_address_province: $_id.sap
        total_orders: 1
        total_revenue: 1
        total_customers:
          $size: $total_customers
    - $sort:
        total_orders: -1


        