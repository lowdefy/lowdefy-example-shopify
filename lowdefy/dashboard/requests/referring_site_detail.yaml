id: referring_site_detail
type: MongoDBAggregation
connectionId: orders_mdb
properties:
  pipeline:
    - $match:
        test: false
        financial_status: paid
    - $addFields:
        start_date:
          _state: start_date
        end_date:
          $dateFromParts:
            year:
              $year:
                _state: end_date
            month:
              $month:
                _state: end_date
            day:
              $add:
                - $dayOfMonth:
                    _state: end_date
                - 1
    - $match:
        $expr:
          $and:
            - $gte:
              - $created_at_date
              - $start_date
            - $lt:
              - $created_at_date
              - $end_date
    - $project:
        landing_site:
          $cond:
            - $regexMatch:
                input: $landing_site
                regex: '\?'
            - $landing_site
            - $concat:
                - $landing_site
                - '?'
        referring_domain:
          $regexFind:
            input: $referring_site
            regex: 'https:\/\/(.*?)\/'
    - $project:
        landing_site_path:
          $regexFind:
            input: $landing_site
            regex: (\/.*?)\?
        referring_domain:
          $arrayElemAt:
            - $referring_domain.captures
            - 0
    - $addFields:
        landing_site_path:
          $ifNull:
            - $arrayElemAt:
                - $landing_site_path.captures
                - 0
            - None
        referring_domain:
          $cond:
            - $regexMatch:
                input: $referring_domain
                regex: google
            - Google
            - $referring_domain
    - $group:
        _id:
          referring_domain: $referring_domain
          landing_site_path: $landing_site_path
        count:
          $sum: 1
    - $project:
        _id: 0
        referring_domain:
          $ifNull:
            - $_id.referring_domain
            - None
        landing_site_path: $_id.landing_site_path
        count: 1
    - $sort:
        count: -1
    - $limit: 100



        